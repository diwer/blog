---
title: java的原子操作
tags: [java,thread,并发,原子操作]
date: 2017-07-21
grammar_cjkRuby: true
---
日期: 2017-07-21 10:26:44

# java的原子操作
在java中可以通过锁和循环CAS的方式来实现原子操作。
## 使用循环CAS实现原子操作     
JVM中的CAS操作正是利用了处理器提供的CMPXCHG指令实现的。自旋CAS实现的基本思路就是循环进行CAS操作直到成功为止.
### CAS实现原子操作的三大问题

* ABA问题

CAS需要在操作值的时候,检查有没有发生变化,如果没有发生变化则更新,但是如果一个值原来是A,变成了B,又变成了A,那么使用CAS进行检查时会发现它的值没有发生变化,但是实际上变化了,ABA问题的解决思路就是使用版本号.在变量前面追加上版本号,每次变量更新的时候把版本号加1,,
jdk1.5开始, 类AtomicStampedReference来解决ABA问题.这个累的compareAndSet方法的作用,先检查当前引用是否等于预期引用,并且检查当前标志是否等于预期标志,如果全不相等,则以远在方式将该引用和该标志的值设置为给定的更新值.

*  循环时间长开销大,

自旋CAS如果长时间不成功，会给CPU带来非常大的执行开销。如果JVM能支持处理器提供的pause指令那么效率会有一定的提升，pause指令有两个作用，第一它可以延迟流水线执行指令（de-pipeline）,使CPU不会消耗过多的执行资源，延迟的时间取决于具体实现的版本，在一些处理器上延迟时间是零。第二它可以避免在退出循环的时候因内存顺序冲突（memory order violation）而引起CPU流水线被清空（CPU pipeline flush），从而提高CPU的执行效率。
* 只能保证一个共享变量的原子操作

当对一个共享变量执行操作时，我们可以使用循环CAS的方式来保证原子操作，但是对多个共享变量操作时，循环CAS就无法保证操作的原子性，这个时候就可以用锁，或者有一个取巧的办法，就是把多个共享变量合并成一个共享变量来操作。比如有两个共享变量i＝2,j=a，合并一下ij=2a，然后用CAS来操作ij。从Java1.5开始JDK提供了AtomicReference类来保证引用对象之间的原子性，你可以把多个变量放在一个对象里来进行CAS操作

## 使用锁机制实现原子操作

锁机制保证了只有获得锁的线程才能够操作锁定的内存区域,jvm内部实现了很多种锁,`偏向锁`,`轻量锁`,`互斥锁`.java实现锁的方式都是用了循环cas,即当一个线程想进入同步块的时候使用循环cas的方式来获取锁,当它退出同步块的时候使用循环cas释放锁


###### 结束
----

wanheming1991@gmail.com