---
title: synchronized详解 
tags: [并发,synchronized]
date: 2017-06-24
grammar_cjkRuby: true
---
日期: 2017-06-24 14:35:34

# Synchronized详解
* CAS (Compare and Swap)
	比较并设置，用于在硬件层面上提供原子性操作。
## 同步的基础
java中的每一个对象都可以作为锁
* 对于同步方法，锁是当前实例对象
* 对于静态同步方法，所示当前对象的Class对象
* 对于同步方法快，锁是Synchonized括号里配置的对象
当一个线程师徒访问同步代码块，他首先必须的到锁，退出或跑出异常时必须释放锁，那么锁存在哪里呢？锁里面会存储什么信息呢
## 同步原理
jvm规范规定jvm基于进入和退出monitor对象来实现方法同步和代码块同步，但两者的实现细节不一样，代码块同步是使用monitorenter和monitorexit指令实现，而方法同步是使用另外一种方式实现的，细节在jvm规范里没有详细说明，但是方法的同步同样可以使用这两个指令来实现。
monitorenter指令是在编译后插入到同步代码块开始的位置，而monitorexit是插入到方法结束处和异常出，jvm要保证每个monitorenter必须有对应的monitorexit与之配对。热河对象都有一个monitor与之关联，而且一个monitor被持有后，它将出去锁定状态。线程执行到monitorenter指令时，将会尝试获取对象所对应monitor的所有权，即尝试获得对象的锁。
### java对象头
锁存在java对象头里，如果对象的数组类型，则虚拟机用3个word存储对象头，如果对象是非数组类型，则用2字宽存储对象头。在32位虚拟机中，一字宽等于4字节，即32bit。
* mark word 存储对象的hashcode或锁信息
* class Metadat address 存储到对象类型数据的指针
* Array length 数组的长度（如果当前对象是数组）
java对象头里的Mark word里默认存储对象的hashcode，分代年龄和锁标记位，32位jvm的markword的默认存储结构
在运行期间Mark Word里存储的数据会随着锁标志位的变化而变化。Mark Word可能变化存储以下4数据
![Mark word结构][1]
64位虚拟机Mark Word是64bit大小，其存储结构如下
![64Mark word 存储结构][2]
### 锁的升级
为了减少获得锁和释放锁带来的性能小号，引入 偏向锁和轻量级锁，锁的状态有四种，无锁状态，偏向锁状态，轻量级锁状态，重量级锁状态，会随着竞争情况升级。锁可以升级但不能降级，意味着偏向锁升级成清凉所后不能降级成偏向锁，这种不能降级的策略，目的是为了提高锁和释放锁的效率
### 偏向锁
当一个线程访问同步块并获取锁，会在对象头和栈帧中的锁记录里存储偏向的线程ID,以后该线程在进入和退出同步块时不需要花费cas操作来加锁和解锁，而只需要简单的测试一下对象头的MarkWord里是否存储着只想当前线程的偏向锁。测试失败，再测试mark word中的偏向锁标识，如果没有设置，则使用CAS竞争锁，如果设置，则尝试使用CAS将对象头的偏向锁指向当前线程
### 轻量锁
线程在执行同步块之前，jvm会现在当前线程的栈帧中创建用于存储锁记录的空间，并将对象头中的Mark word复制到锁记录中，官方称为displaced mark word，然后线程尝试将cas对象头中的Mark word替换为指向锁记录的指针。如果成功，当前线程获得锁，如果失败，表示其线程竞争锁，当前线程遍尝试使用自旋来获取锁
自旋会消耗cpu，为了避免无用的自旋，锁升级为了重量锁，就不会再恢复到轻量级锁状态，当锁处于这个状态下，其他线程试图获取锁时，都会被阻塞住，当尺有所的线程释放锁之后会环形这些线程，被唤醒的线程就会进行新一轮的锁的竞争
## 锁的优缺点对比
### 偏向锁
* 优点：加锁和解锁不需要额外的消耗
* 缺点：线程间存在锁竞争，会带了额外的锁撤销消耗
* 适用场景：适用于只有一个线程访问同步块
### 轻量级锁
* 优点：竞争的线程不会阻塞，提高了线程的相应速度
* 缺点
	始终得不到锁竞争的线程会自旋消耗Cpu
* 适用场景：追求响应时间。同步块执行速度非常快
### 重量级锁
* 优点：线程竞争不适用自旋
* 缺点：线程阻塞，响应时间缓慢
* 适用场景 ：追求吞吐量。同步块执行速度较慢



----

wanheming1991@gmail.com


  [1]: http://oq6m1y13p.bkt.clouddn.com/1498315207306.jpg
  [2]: http://oq6m1y13p.bkt.clouddn.com/1498315312121.jpg